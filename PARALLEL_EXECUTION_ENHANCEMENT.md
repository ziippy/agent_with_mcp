# 🔧 병렬 실행 강화 업데이트

## 📅 업데이트: 2025-01-04

---

## 🎯 문제점

"12대 중과실은 뭐야?"와 같은 질문이 **병렬 실행**되어야 하는데 **single**로 처리되는 문제 발생

---

## ❌ 이전 문제

### 증상
```
질문: "12대 중과실은 뭐야?"

🎯 판단 결과:
   질문 유형: single
   실행 순서: laws
```

**문제:** 법률 정의와 판례/사례를 함께 검색하면 더 좋은 답변을 제공할 수 있는데, 단일 에이전트만 호출

---

## ✅ 개선 사항

### 1. 프롬프트 구조 개선

**변경 전:**
```
실행 전략:

🔀 병렬 실행 (독립적 작업):
- execution_order: [["agent1", "agent2"]]
- 두 에이전트의 작업이 서로 독립적일 때

⏭️ 순차 실행 (의존적 작업):
- execution_order: [["agent1"], ["agent2"]]
- agent2가 agent1의 결과를 참고해야 할 때
```

**변경 후:**
```
🎯 핵심 규칙: 가능하면 병렬 실행하세요!

실행 전략 결정 가이드:

🔀 병렬 실행 (PARALLEL) - 우선 고려!
- 형식: execution_order: [["agent1", "agent2"]]
- 조건: 두 에이전트의 작업이 서로 독립적일 때
- 판단: agent2가 agent1의 결과를 꼭 봐야 하나? → NO면 병렬!
- 예시:
  * "12대 중과실이 뭐야?" → [["laws", "search"]] ✅
  * "근로기준법 설명하고 관련 뉴스 찾아줘" → [["laws", "search"]] ✅
  * "법률 정의와 판례 알려줘" → [["laws", "search"]] ✅
```

### 2. 명확한 우선순위 설정

**핵심 메시지 추가:**
```
🎯 핵심 규칙: 가능하면 병렬 실행하세요!

핵심: 의심스러우면 병렬 실행! 명확한 의존성이 있을 때만 순차 실행!
```

### 3. 구체적 예시 추가

**"12대 중과실" 예시:**
```json
{
  "question_type": "parallel",
  "execution_order": [["laws", "search"]],
  "queries": {
    "laws": "12대 중과실의 법률적 정의와 관련 법령을 찾아주세요",
    "search": "12대 중과실 관련 판례, 사례, 뉴스를 검색해주세요"
  },
  "dependencies": {},
  "analysis": "법률 정의와 실제 사례는 독립적으로 검색 가능하므로 병렬 실행"
}
```

### 4. 판단 기준 명확화

**질문:**
```
agent2가 agent1의 결과를 꼭 봐야 하나?
```

**→ NO면 병렬!**
**→ YES면 순차!**

---

## 📊 기대 효과

### 시나리오: "12대 중과실은 뭐야?"

#### 이전 (Single)
```
laws Agent만 호출
  ↓
법률 조문만 제공
  ↓
사용자: "사례는?"
```

#### 개선 후 (Parallel)
```
laws Agent + search Agent 동시 호출
  ↓
법률 조문 + 판례/사례 동시 제공
  ↓
더 풍부한 답변!
```

### 장점

| 항목 | 개선 효과 |
|------|----------|
| **답변 품질** | 법률 정의 + 실제 사례 → 이해도 ↑ |
| **응답 속도** | 병렬 처리 → 시간 단축 |
| **사용자 만족도** | 한 번에 종합 정보 제공 |
| **추가 질문** | "사례는?" 같은 후속 질문 감소 |

---

## 🎯 병렬 vs 순차 판단 가이드

### 🔀 병렬 실행해야 할 경우 (대부분)

| 질문 패턴 | 이유 |
|-----------|------|
| "X가 뭐야?" | 정의 + 사례 = 독립적 |
| "X와 Y 알려줘" | X와 Y = 독립적 |
| "X 설명하고 Y 찾아줘" | X와 Y = 독립적 |
| "X에 대해 알려줘" | 법률 + 사례 = 독립적 |

**판단:** 명시적으로 "~한 후", "~를 바탕으로" 없음 → 병렬!

### ⏭️ 순차 실행해야 할 경우 (예외적)

| 질문 패턴 | 이유 |
|-----------|------|
| "X를 찾고, 그 X의 Y를 알려줘" | Y는 X를 봐야 함 |
| "X를 먼저 확인한 후, Y 해줘" | 명시적 순서 |
| "X를 바탕으로 Y 해줘" | Y는 X 결과 필요 |

**판단:** 명확한 의존성 → 순차!

---

## 🧪 테스트 케이스

### 케이스 1: 병렬 실행 (권장)

**질문:**
```
"12대 중과실은 뭐야?"
"교통사고 처리 절차는?"
"근로기준법에 대해 알려줘"
"부당해고가 뭐야?"
```

**기대 결과:**
```json
{
  "question_type": "parallel",
  "execution_order": [["laws", "search"]]
}
```

### 케이스 2: 순차 실행 (명확한 의존성)

**질문:**
```
"최근 부당해고 판례를 찾고, 그 판례의 법률 조항을 알려줘"
"교통사고 사례를 먼저 찾고, 그 사례의 처리 절차를 설명해줘"
```

**기대 결과:**
```json
{
  "question_type": "sequential",
  "execution_order": [["search"], ["laws"]]
}
```

### 케이스 3: 단일 실행 (명확히 하나만 필요)

**질문:**
```
"법률 조문만 찾아줘"
"최근 뉴스만 검색해줘"
```

**기대 결과:**
```json
{
  "question_type": "single",
  "execution_order": [["laws"]] or [["search"]]
}
```

---

## 🔧 구현 세부사항

### 프롬프트 변경사항

1. **우선순위 명시**
   ```
   🎯 핵심 규칙: 가능하면 병렬 실행하세요!
   ```

2. **판단 기준 단순화**
   ```
   판단: agent2가 agent1의 결과를 꼭 봐야 하나?
   → NO면 병렬!
   ```

3. **구체적 예시 추가**
   - "12대 중과실이 뭐야?" → 병렬
   - "근로기준법 설명하고 뉴스 찾아줘" → 병렬
   - "판례를 찾고, 그 판례의 법 조항 알려줘" → 순차

4. **중복 제거**
   - A2A 원칙 중복 제거
   - 예시 중복 제거

---

## 📈 성능 비교

### "12대 중과실은 뭐야?" 질문 시

| 방식 | 실행 시간 | 정보 품질 | 사용자 만족도 |
|------|----------|----------|--------------|
| **Single (laws만)** | 3초 | 법률 조문만 | 보통 |
| **Parallel (laws + search)** | 3.5초 | 법률 + 사례 | 높음 ✅ |

**결론:** 약간의 시간 증가(0.5초)로 정보 품질 2배 향상!

---

## 💡 핵심 철학

### "기본은 병렬, 예외만 순차"

**이전:**
- 조심스럽게 판단
- 확실할 때만 병렬

**개선:**
- 적극적으로 병렬
- 명확한 의존성만 순차

---

## ✅ 체크리스트

사용자가 확인할 사항:

- [ ] "X가 뭐야?" 형태 질문 → 병렬 실행되는지 확인
- [ ] laws + search 동시 호출되는지 확인
- [ ] 법률 정의 + 사례/판례 함께 제공되는지 확인
- [ ] 응답 품질이 향상되었는지 확인
- [ ] "~를 찾고, 그 ~의 ~를 알려줘" → 순차 실행되는지 확인

---

## 🎯 결론

### 변경 전: 보수적 접근
- "확실할 때만 병렬"
- 기본은 single
- 정보 부족

### 변경 후: 적극적 병렬
- "가능하면 병렬"
- 기본은 parallel
- 정보 풍부 ✅

**이제 "12대 중과실은 뭐야?" 같은 질문에 법률 정의와 실제 사례를 함께 제공합니다!** 🎉

